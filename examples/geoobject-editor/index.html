<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Пример реализации редактора геообъектов</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link href="/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="geoobject-editor.css" rel="stylesheet">
    <script src="//api-maps.yandex.ru/2.0/?load=package.full,util.augment&lang=ru-RU&mode=debug" type="text/javascript"></script>
    <!--script src="//yandex.st/jquery/1.8.0/jquery.min.js" type="text/javascript"></script-->
    <script src="//code.jquery.com/jquery-1.8.2.js" type="text/javascript"></script>
    <!--script src="//backbonejs.org/backbone.js" type="text/javascript"></script-->

    <script type="text/javascript">
ymaps.ready(function () {
    var map = new ymaps.Map('YMapsID', {
        center: [55.751574, 37.573856],
        zoom: 9,
        behaviors: ['drag', 'scrollZoom']
    });

    function EditableGeoObjectCollection() {
        EditableGeoObjectCollection.superclass.constructor.apply(this, arguments);

        this.editor = new GeoObjectCollectionEditor(this);
        this.balloon = new EditableGeoObjectCollectionBalloon(this);
    }

    function EditableGeoObjectCollectionBalloon(collection) {
        this.geoObjects = collection;
    }

    EditableGeoObjectCollectionBalloon.prototype = {
        constructor: EditableGeoObjectCollectionBalloon,

        open: function (position, data, options) {
            var balloon = this.geoObjects.getMap() && this.geoObjects.getMap().balloon;

            if(balloon) {
                this.balloon = balloon.open.call(balloon, position, data, options);
                this.geoObjects.events.fire('balloonopen', {
                    balloon: this.balloon
                });
            }

            return this.balloon;
        },

        close: function () {
            this.balloon && this.balloon.close();
            this.geoObjects.events.fire('balloonclose', {});
        }
    };

    ymaps.util.augment(EditableGeoObjectCollection, ymaps.GeoObjectArray);

    function GeoObjectCollectionEditor(collection) {
        this.geoObjects = collection;
    }

    GeoObjectCollectionEditor.prototype = {
        constructor: GeoObjectCollectionEditor,

        startEditing: function (options) {
            var eventName = options && options.editEvent ||
                this.geoObjects.options.get('editEvent', 'contextmenu'); // По-умолчанию редактируем геообъекты по клику правой кнопкой мышки.

            this.geoObjects.events.add(eventName, this.onEditGeoObject, this);

        },
        stopEditing: function () {

        },
        startDrawing: function (options) {
            var eventName = options && options.addEvent ||
                this.geoObjects.options.get('addEvent', 'click'); // По-умолчанию добавляем геообъекты по клику.

            this.getMap().events.add(eventName, this.onCreateGeoObject, this);
            this.geoObjects.events.add('geoobjectcreated', this.onGeoObjectCreated, this);
        },
        stopDrawing: function () {
        },

        onGeoObjectAdded: function (e) {
            console.log('geoObject added', e);
        },

        getMap: function () {
            if(!this.geoObjects.getMap()) {
                throw new Error('EditableGeoObjectCollection must be added on map for drawing');
            }

            return this.geoObjects.getMap();
        },

        onCreateGeoObject: function (e) {
            console.log('click');
            var coordinates = e.get('coordPosition');

            this.geoObjects.balloon.open(e.get('coordPosition'), { geoObjects: this.geoObjects, coordPosition: coordinates }, {
                contentLayout: GeoObjectCollectionView.getLayout('createMenu')
            });
        },

        onGeoObjectCreated: function (e) {
            var geoObject = e.get('geoObject'),
                geoObjects = e.get('target'),
                onStateChange = function (e) {
                    if(e.get('newDrawing') === false) {
                        geoObject.editor.events.remove('statechange', onStateChange, this);
                        this.openGeoObjectEditor(geoObject);
                    }
                };

            geoObjects.add(geoObject);

            // У круга и прямоугольника пока нет редактора
            if(geoObject.editor) {
                geoObject.editor.startDrawing();
                // в обработчике события нельзя получить ссылку на геообъект, поэтому передаем его в контексте.
                geoObject.editor.events.add('statechange', onStateChange, this);
            }
            else {
                geoObject.balloon.open();
            }
        },

        openGeoObjectEditor: function (geoObject) {
            var geometryType = geoObject.geometry.getType();

            geoObject.options.set({
                balloonContentBodyLayout: GeoObjectEditorView.getLayout('editForm'),
                balloonFieldsetLayout: GeoObjectEditorView.getLayout(geometryType + 'Fieldset'),
                balloonActionsLayout: GeoObjectEditorView.getLayout('editFormActions'),
                hideIconOnBalloonOpen: false
            });

            geoObject.properties.set('balloon', geoObject.balloon.open());
        }
    };

var GeoObjectCollectionView = (function () {

    var views = {
        CreateMenu: ymaps.templateLayoutFactory.createClass([
            '<ul class="nav nav-list">',
                '<li class="nav-header">Создать</li>',
                '<li><a href="#" data-geometry="Point">Метку</a></li>',
                '<li><a href="#" data-geometry="LineString">Ломаную линию</a></li>',
                '<li><a href="#" data-geometry="Polygon">Многоугольник</a></li>',
                '<li><a href="#" data-geometry="Rectangle">Прямоугольник</a></li>',
                '<li><a href="#" data-geometry="Circle">Круг</a></li>',
            '</ul>'
        ].join(''), {
            build: function () {
                GeoObjectCollectionView.getLayout('createMenu').superclass.build.call(this);

                var el = this.getParentElement();

                this.menu = $('.nav', el)
                    .on('click', $.proxy(this.onItemClick, this));
            },
            clear: function () {
                this.menu.off('click');

                GeoObjectCollectionView.getLayout('createMenu').superclass.clear.call(this);
            },
            onItemClick: function (e) {
                var target = $(e.target),
                    geometry = target.data('geometry'),
                    geoObjects = this.getData().geoObjects,
                    coordinates = this.getData().coordPosition;

                e.preventDefault();

                switch(geometry) {
                    case 'LineString':
                        coordinates = [coordinates];
                        break;
                    case 'Polygon':
                        coordinates = [[coordinates, coordinates]];
                        break;
                    case 'Rectangle':
                        coordinates = [coordinates, coordinates];
                        break;
                }

                geoObjects.events.fire('geoobjectcreated', {
                    geoObject: new ymaps.GeoObject({
                        geometry: { type: geometry, coordinates: coordinates }
                    }),
                    target: geoObjects
                });

                geoObjects.balloon.close();
            }
        })
    };

    return {
        getLayout: function (key) {
            return views[key.charAt(0).toUpperCase() + key.substring(1)];
        }
    };

}());

var GeoObjectEditorView = (function () {

    var BaseFieldset = ymaps.templateLayoutFactory.createClass('', {
        getFieldsValues: function () {
            var result = {};

            this.fields.each(function () {
                result[this.name] = this.value;
            });

            return result;
        },
        setFieldsValues: function () {
            var props = this.fields.map(function () { return this.name; }).get();

            props.forEach(function (prop) {
                var value = this.geoObject.properties.get(prop);

                value && this.fields.filter('[name=' + prop + ']').val(value);
            }, this);
        },
        onFieldsChange: function (e) {
            this.updateGeoObject(this.getFieldsValues());
        },
        updateGeoObject: function (props) {
            var geoObject = this.geoObject;

            geoObject.options.set(props);
            geoObject.properties.set(props);
        },
        clear: function () {
            console.log(this);
            this.fields.off('change');

            GeoObjectEditorView.getLayout(this.layout).superclass.clear.call(this);
        }
    });

    var views = {
        EditForm: ymaps.templateLayoutFactory.createClass([
            '<form class="form-horizontal" style="padding-top: 15px">',
                '<fieldset>',
                    // '<legend>$[properties.editor.legend]</legend>',
                    '<div class="control-group">',
                        '<label class="control-label">Название</label>',
                        '<div class="controls">',
                            '<input class="input-xlarge" type="text" name="name" tabindex="1" placeholder="Название объекта" value="$[properties.name]"/>',
                        '</div>',
                    '</div>',
                    '<div class="control-group">',
                        '<label class="control-label">Описание</label>',
                        '<div class="controls">',
                            '<textarea rows="3" class="input-xlarge" name="description" tabindex="2" placeholder="Описание объекта">$[properties.description]</textarea>',
                        '</div>',
                    '</div>',
                    '$[[options.fieldsetLayout]]',
                    '$[[options.actionsLayout]]',
                '</fieldset>',
            '</form>'
        ].join(''), {
            build: function () {
                GeoObjectEditorView.getLayout('editForm').superclass.build.call(this);

                var el = this.getParentElement(),
                    geoObject = this.geoObject = this.getData().geoObject;

                this.form = $('form', el)
                    .on('submit', $.proxy(this.onSubmit, this));

                this.fields = $('[name=name],[name=description]', el)
                    .on('change', $.proxy(this.onChange, this));
            },
            clear: function () {
                this.form.off('submit');
                this.fields.off('change');

                GeoObjectEditorView.getLayout('editForm').superclass.clear.call(this);
            },
            onChange: function (e) {
                var field = $(e.target);

                this.geoObject.properties.set(field.attr('name'), field.val());
            },
            onSubmit: function (e) {
                e.preventDefault();

                this.geoObject.balloon.close();
                this.geoObject.options.set('balloonContentBodyLayout', GeoObjectView.getLayout('balloonContent'));
            }
        }),

        EditFormActions: ymaps.templateLayoutFactory.createClass([
            '<div class="form-actions" style="margin: 0 -15px 0 -15px">',
                '<button type="submit" class="btn btn-primary">Сохранить</button>',
                '<button type="reset" class="btn" style="margin-left: 10px">Отменить</button>',
            '</div>'
        ].join(''), {
            build: function () {
                GeoObjectEditorView.getLayout('editFormActions').superclass.build.call(this);

                var el = this.getParentElement(),
                    geoObject = this.geoObject = this.getData().geoObject;

                this.reset = $('[type=reset]', el)
                    .on('click', $.proxy(this.onCancel, this));
            },
            clear: function () {
                this.reset.off('click');

                GeoObjectEditorView.getLayout('editFormActions').superclass.clear.call(this);
            },
            onCancel: function (e) {
                e.preventDefault();

                this.geoObject.setParent(null);
            }
        }),

        PointFieldset: ymaps.templateLayoutFactory.createClass([
            '<div class="control-group">',
                '<label class="control-label">Координаты</label>',
                '<div class="controls">',
                    '<input class="input-xlarge" type="text" name="coordinates" tabindex="3" value="$[geometry.coordinates]"/>',
                '</div>',
            '</div>',
            '<div class="control-group">',
                '<label class="control-label">Адрес</label>',
                '<div class="controls">',
                    '<input class="input-xlarge" type="text" name="address" tabindex="4" placeholder="Адрес объекта" value="$[properties.address]"/>',
                '</div>',
            '</div>',
            '<div class="control-group">',
                '<label class="control-label">Тип иконки</label>',
                '<div class="controls">',
                    '<select class="input-xlarge" tabindex="5" name="iconStyle">',
                        '<option value="Icon">Метки без содержимого</option>',
                        '<option value="DotIcon">Метки без содержимого с точкой в центре</option>',
                        '<option value="StretchyIcon">Метки с текстом (иконки тянутся под контент)</option>',
                        // '<option value="standart">Стандартные значки (пиктограммы)</option>',
                    '</select>',
                '</div>',
            '</div>',
            '<div class="control-group">',
                '<label class="control-label">Цвет иконки</label>',
                '<div class="controls">',
                    '<select class="input-xlarge" tabindex="6" name="iconColor">',
                        '<option value="blue">Синий</option>',
                        '<option value="darkblue">Темно-синий</option>',
                        '<option value="green">Зеленый</option>',
                        '<option value="darkgreen">Темно-зеленый</option>',
                        '<option value="orange">Оранжевый</option>',
                        '<option value="darkorange">Темно-оранжевый</option>',
                        '<option value="pink">Розовый</option>',
                        '<option value="red">Красный</option>',
                        '<option value="yellow">Желтый</option>',
                        '<option value="brown">Коричневый</option>',
                        '<option value="violet">Фиолетовый</option>',
                        '<option value="night">Цвет ночи</option>',
                        '<option value="white">Белый</option>',
                        '<option value="grey">Серый</option>',
                        '<option value="black">Черный</option>',
                    '</select>',
                '</div>',
            '</div>'
        ].join(''), {
            build: function () {
                var el = this.getParentElement(),
                    geoObject = this.geoObject = this.getData().geoObject,
                    geometryType = geoObject.geometry.getType();

                this.layout = geometryType + 'Fieldset';

                GeoObjectEditorView.getLayout(this.layout).superclass.build.call(this);

                this.fields = $('[name^=icon]', el)
                    .on('change', $.proxy(this.onFieldsChange, this));

                this.positionField = $('[name=coordinates]', el)
                    .on('change', $.proxy(this.onPositionChange, this));

                this.setFieldsValues();

                if(!geoObject.properties.get('address')) {
                    this.getAddress(geoObject.geometry.getCoordinates(), function (res) {
                        var result = res.geoObjects.get(0),
                            address = result && result.properties.get('text');

                        address && geoObject.properties.set('address', address);
                    });
                }
            },
            clear: function () {
                this.fields.off('change');
                this.positionField.off('change');

                GeoObjectEditorView.getLayout(this.layout).superclass.clear.call(this);
            },
            onPositionChange: function (e) {
                var geoObject = this.geoObject,
                    coordinates = $(e.target).val().split(',');

                geoObject.geometry.setCoordinates(coordinates);
                geoObject.properties.get('balloon').autoPan();
            },
            updateGeoObject: function (props) {
                var geoObject = this.geoObject,
                    geoObjects = geoObject.getParent(),
                    index = geoObjects.indexOf(geoObject),
                    preset = 'twirl#' + props.iconColor + props.iconStyle;

                geoObject.options.set('preset', preset)
                    .unset('iconContentLayout');

                geoObject.properties.set(props);

                switch(props.iconStyle) {
                    case 'StretchyIcon':
                        geoObject.options.set('iconContentLayout', GeoObjectView.getLayout('strechyIconContent'));
                        break;
                    case 'Icon':
                        index++ < 100 && geoObject.properties.set('iconContent', index);
                        break;
                    default:
                        geoObject.properties.unset('iconContent');
                }
            },
            getAddress: function (coordinates, callback) {
                ymaps.geocode(coordinates, { results: 1 })
                    .then(callback);
            }
        }),

        LineStringFieldset: ymaps.templateLayoutFactory.createClass([
            '<div class="control-group">',
                '<label class="control-label">Цвет линии</label>',
                '<div class="controls">',
                    '<input type="text" name="strokeColor" class="input-xlarge" placeholder="FFFFFFAA или rgba(255,0,0,1)" value="$[properties.strokeColor]">',
                '</div>',
            '</div>',
            '<div class="control-group">',
                '<label class="control-label">Толщина линии</label>',
                '<div class="controls">',
                    '<input type="text" name="strokeWidth" class="input-micro" placeholder="1" value="$[properties.strokeWidth]">',
                '</div>',
            '</div>',
            '<div class="control-group">',
                '<label class="control-label">Стиль линии</label>',
                '<div class="controls">',
                    '<select class="input-xlarge" tabindex="6" name="strokeStyle">',
                        '<option value="solid">Сплошная линия</option>',
                        '<option value="dash">Тире</option>',
                        '<option value="dashdot">Длинное тире - короткое тире</option>',
                        '<option value="dot">Точки</option>',
                        '<option value="longdash">Длинные тире</option>',
                        '<option value="longdashdot">Очень длинное тире - точка</option>',
                        '<option value="longdashdotdot">Длинное тире - точка - точка</option>',
                        '<option value="shortdash">Короткие тире</option>',
                        '<option value="shortdashdot">Тире - точка</option>',
                        '<option value="shortdashdotdot">Тире - точка - точка</option>',
                        '<option value="shortdot">Точки через двойной интервал</option>',
                    '</select>',
                '</div>',
            '</div>'
        ].join(''), {
            build: function () {
                var el = this.getParentElement(),
                    geoObject = this.geoObject = this.getData().geoObject,
                    geometryType = geoObject.geometry.getType();

                this.layout = geometryType + 'Fieldset';

                GeoObjectEditorView.getLayout(this.layout).superclass.build.call(this);

                this.fields = $('[name^=stroke]', el)
                    .on('change', $.proxy(this.onFieldsChange, this));

                this.setFieldsValues();
            }
        })
    };

    ymaps.util.augment(views['PointFieldset'], BaseFieldset);
    ymaps.util.augment(views['LineStringFieldset'], BaseFieldset);

    return {
        getLayout: function (key) {
            return views[key.charAt(0).toUpperCase() + key.substring(1)];
        }
    };

}());

var GeoObjectView = (function () {

    var views = {
        EditMenu: ymaps.templateLayoutFactory.createClass([
            '<ul class="nav nav-list">',
                '<li><a href="#" data-action="edit">Редактировать</a></li>',
                '<li><a href="#" data-action="clone">Редактировать копию</a></li>',
                '<li><a href="#" data-action="delete">Удалить</a></li>',
            '</ul>'
        ].join('')),

        StrechyIconContent: ymaps.templateLayoutFactory.createClass('<span>$[properties.name]</span>'),

        BalloonContent: ymaps.templateLayoutFactory.createClass([
            '<div>',
                '<h3>$[properties.name]</h3>',
                '<p class="lead">$[properties.description]</p>',
                '[if properties.address]<address>$[properties.address]</address>[endif]',
            '</div>'
        ].join(''))
    };

    return {
        getLayout: function (key) {
            return views[key.charAt(0).toUpperCase() + key.substring(1)];
        }
    };

}());


    var editableCollection = new EditableGeoObjectCollection();

    map.geoObjects.add(editableCollection);

    editableCollection.editor.startDrawing();

});
    </script>
    <style type="text/css">
html,body {
    position: absolute;
    width: 100%;
    height: 100%;
}
    </style>
</head>

<body>
    <div class="well container-fluid" style="height:100%">
        <p class="lead">Редактор геообъектов</p>
        <div id="YMapsID" style="width: 100%; height: 100%"></div>
    </div>
    </div>
</body>

</html>
