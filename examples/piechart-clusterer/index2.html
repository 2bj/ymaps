<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Пример PieChart кластеризатора</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script src="//yandex.st/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
    <script src="//ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js" type="text/javascript"></script>
    <script src="//api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU&mode=debug" type="text/javascript"></script>
    <link href="/bootstrap/css/bootstrap.css" rel="stylesheet">
    <script src="/bootstrap/js/bootstrap.js" type="text/javascript"></script>
    <script src="https://raw.github.com/dimik/ymaps/master/points-generator.js" type="text/javascript"></script>
    <script src="https://raw.github.com/dimik/ymaps/master/piechart-clusterer.js" type="text/javascript"></script>

    <script type="text/javascript">
        ymaps.ready(function () {
            // Создание экземпляра карты и его привязка к созданному контейнеру
            var myMap = new ymaps.Map("map", {
                center: [55.755768, 37.617671], // Москва
                zoom: 10,
                behaviors: ["default", "scrollZoom"]
            });

            var generator = new RandomPointsGenerator();

            // Перекрываем метод генератора меток для создания случайных пресетов 4-х типов.
            var presets = ['twirl#blueIcon', 'twirl#orangeIcon', 'twirl#greenIcon', 'twirl#redIcon'];
            generator.getPointOptions = function (i) {
                return {
                    preset: presets[Math.floor(Math.random() * presets.length)]
                };
            };
            generator.getPointData = function (i) {
                return {
                    id: 'item-' + (i + 1),
                    title: 'Метка ' + (i + 1),
                    balloonContent: 'Метка ' + (i + 1)
                };
            };

            // Создаем 200 меток внутри области видимости карты.
            var points = generator.generate(200).atBounds(myMap.getBounds()),
                // Стили для DOM-представлений групп.
                presetStyles = {
                    "red": "important",
                    "green": "success",
                    "orange": "warning",
                    "blue": "info"
                },
                presetTitles = {
                    "red": "Красный",
                    "green": "Зеленый",
                    "orange": "Оранжевый",
                    "blue": "Синий"
                },
                groups = $.map(presets, function (preset, index) {
                    var color = preset.match(/#([a-z]+)[A-Z]/)[1];

                    return {
                        id: 'group-' + index,
                        active: !!index,
                        title: presetTitles[color],
                        style: presetStyles[color],
                        points: $.grep(points, function (point) { return point.options.get('preset') === preset; })
                    };
                }),
                clusterer = new PieChartClusterer();

            // Добавляем метки в кластеризатор.
            clusterer.add(points);
            // Добавляем кластеризатор на карту.
            myMap.geoObjects.add(clusterer);

            // Контейнер для меню.
            var sidebar = $('#sidebar'),
                sidebarTemplate = $('#sidebarTemplate').template('sidebarTemplate');

            sidebar.html($.tmpl(sidebarTemplate, {
                clusterer: clusterer,
                groups: groups
            }))
            .on('click', 'tr', function (e) {
                var id = this.id,
                    point = points.filter(function (point) { return point.properties.get('id') === id; })[0],
                    state = clusterer.getObjectState(point);

                myMap.panTo((state.isClustered && state.cluster.geometry || point.geometry).getCoordinates());
            });

            clusterer.events.add('objectsaddtomap', function () {
                sidebar
                    .find('tr[id^=item]')
                    .each(function (it) {
                        var id = this.id,
                            point = points.filter(function (point) {
                                return point.properties.get('id') === id;
                            })[0],
                            state = clusterer.getObjectState(point),
                            coloumns = $(this).find('td');

                        coloumns.eq(2).text(state.isShown);
                        coloumns.eq(3).text(state.isClustered);
                    });
            });
        });
    </script>
    <script id="sidebarTemplate" type="text/x-jquery-tmpl">
        <ul class="nav nav-tabs">
            {{tmpl(groups) "#tabTemplate"}}
        </ul>
        <div class="tab-content">
            {{tmpl(groups) "#tabPaneTemplate"}}
        </div>
    </script>
    <script id="tabTemplate" type="text/x-jquery-tmpl">
        <li>
            <a href="#${id}" data-toggle="tab">
                <span class="label label-${style}">${title}</span>
            </a>
        </li>
    </script>
    <script id="tabPaneTemplate" type="text/x-jquery-tmpl">
        <div class="tab-pane" id="${id}">
            <table class="table table-hover table-striped table-bordered table-condensed">
                <thead>
                    <tr>
                        <th>№</th>
                        <th>Имя</th>
                        <th>Добавлен на карту</th>
                        <th>Добавлен в кластер</th>
                    </tr>
                </thead>
                <tbody>
                {{each(i, point) points}}
                    <tr id="${point.properties.get("id")}">
                        <td>${i + 1}</td>
                        <td>${point.properties.get("title")}</td>
                        <td>${$item.parent.data.clusterer.getObjectState(point).isShown}</td>
                        <td>${$item.parent.data.clusterer.getObjectState(point).isClustered}</td>
                    </tr>
                {{/each}}
                </tbody>
            </table>
        </div>
    </script>
    <style type="text/css">
        .hero-unit {
            background-color: #FFF;
        }
        .well {
            padding: 15px 0;
            height: 520px;
        }
        .label {
            cursor: pointer;
        }
        #map {
            width: 800px;
            height: 520px;
        }
        #sidebar {
            height: 520px;
            overflow: scroll;
        }
    </style>
</head>

<body>
    <div class="hero-unit">
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span12">
                    <p class="lead">Управление коллекцией геообъектов с помощью меню.</p>
                </div>
            </div>
            <div class="row-fluid">
                <div id="map" class="span8"></div>
                <div id="sidebar" class="span4"></div>
            </div>
        </div>
    </div>
</body>

</html>
